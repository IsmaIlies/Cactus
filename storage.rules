rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Nouveautés (PDF): novelties-pdf/<timestamp>-<slug>.pdf
    match /novelties-pdf/{fileName} {
      // Lecture publique (facile pour intégration/aperçu agent)
      allow read: if true;
      // Écriture réservée aux comptes porteurs d'un rôle privilégié ou email autorisé
      allow write: if request.auth != null && (
        request.auth.token.admin == true ||
        (request.auth.token.role is string && lower(request.auth.token.role) in ['admin','direction','superviseur']) ||
        (request.auth.token.email is string && request.auth.token.email in ['i.boultame@mars-marketing.fr','j.allione@mars-marketing.fr','i.brai@mars-marketing.fr'])
      );
    }

    // Nouveautés Vidéos: novelties-video/<timestamp>-<slug>.mp4
    match /novelties-video/{fileName} {
      // Lecture publique (agents peuvent lire/stream)
      allow read: if true;
      // Écriture réservée aux comptes privilégiés (mêmes conditions que PDF)
      allow write: if request.auth != null && (
        request.auth.token.admin == true ||
        (request.auth.token.role is string && lower(request.auth.token.role) in ['admin','direction','superviseur']) ||
        (request.auth.token.email is string && request.auth.token.email in ['i.boultame@mars-marketing.fr','j.allione@mars-marketing.fr','i.brai@mars-marketing.fr'])
      );
    }

    // Miniatures des vidéos: novelties-video-thumbs/<timestamp>-<slug>.jpg
    match /novelties-video-thumbs/{fileName} {
      allow read: if true;
      allow write: if request.auth != null && (
        request.auth.token.admin == true ||
        (request.auth.token.role is string && lower(request.auth.token.role) in ['admin','direction','superviseur']) ||
        (request.auth.token.email is string && request.auth.token.email in ['i.boultame@mars-marketing.fr','j.allione@mars-marketing.fr','i.brai@mars-marketing.fr'])
      );
    }

    // Nouveau dossier pour les programmes: programme-pdf/<timestamp>-<slug>.pdf
    match /programme-pdf/{fileName} {
      // Lecture publique (facile à intégrer côté agents / iframe)
      allow read: if true;
      // Écriture réservée aux comptes porteurs d'un rôle privilégié ou claim admin
      allow write: if request.auth != null && (
        request.auth.token.admin == true ||
        (request.auth.token.role is string && lower(request.auth.token.role) in ['admin','direction','superviseur']) ||
        (request.auth.token.email is string && request.auth.token.email in ['i.boultame@mars-marketing.fr','j.allione@mars-marketing.fr','i.brai@mars-marketing.fr'])
      );
    }

    // Ancien fichier unique (garde compat si existant) : shared/programme.pdf
    match /shared/programme.pdf {
      allow read: if true; // on l'aligne sur la stratégie publique
      allow write: if request.auth != null && (
        request.auth.token.admin == true ||
        (request.auth.token.role is string && lower(request.auth.token.role) in ['admin','direction','superviseur']) ||
        (request.auth.token.email is string && request.auth.token.email in ['i.boultame@mars-marketing.fr','j.allione@mars-marketing.fr','i.brai@mars-marketing.fr'])
      );
    }

    // Par défaut: refus
    match /{allPaths=**} { allow read, write: if false; }
  }
}
